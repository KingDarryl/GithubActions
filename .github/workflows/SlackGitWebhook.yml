name: Branch Protection Slack Notifier

on:
  push:
    branches:
      - main  # or whatever your protected branch is
  repository_dispatch:
    types: [edited]
  workflow_dispatch:  # Keep manual trigger for testing

permissions:
  contents: read
  pull-requests: read

jobs:
  notify-slack:
    runs-on: ubuntu-latest
    steps:
      - name: Debug Event
        run: |
          echo "Event name: ${{ github.event_name }}"
          echo "Event action: ${{ github.event.action }}"
          echo "Repository: ${{ github.repository }}"
          echo "Full payload:"
          echo "${{ toJson(github.event) }}"
          
      - name: Send Slack Notification
        uses: actions/github-script@v6
        with:
          script: |
            try {
              console.log('Starting Slack notification...');
              console.log('Event name:', context.eventName);
              console.log('Event action:', context.payload.action);
              console.log('Full event payload:', JSON.stringify(context.payload, null, 2));
              
              // Get the event details
              const event = context.payload;
              
              // Handle manual trigger
              if (context.eventName === 'workflow_dispatch') {
                const message = {
                  blocks: [
                    {
                      type: "header",
                      text: {
                        type: "plain_text",
                        text: "🔍 Branch Protection Test Notification"
                      }
                    },
                    {
                      type: "section",
                      text: {
                        type: "mrkdwn",
                        text: "This is a test notification from the Branch Protection Slack Notifier workflow."
                      }
                    },
                    {
                      type: "context",
                      elements: [
                        {
                          type: "mrkdwn",
                          text: `Time: ${new Date().toISOString()}`
                        }
                      ]
                    }
                  ]
                };
                
                console.log('Sending test message to Slack:', JSON.stringify(message, null, 2));
                await github.request({
                  method: 'POST',
                  url: process.env.SLACK_WEBHOOK_URL,
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  data: message
                });
                console.log('Test notification sent successfully');
                return;
              }
              
              // Handle repository edits (including branch protection changes)
              if (context.eventName === 'repository' && context.payload.action === 'edited') {
                console.log('Processing repository edit event');
                console.log('Changes:', JSON.stringify(event.changes, null, 2));
                
                const repository = event.repository;
                const sender = event.sender;
                const changes = event.changes || {};
                
                // Check if branch protection settings were changed
                if (changes.default_branch || changes.has_issues || changes.has_projects || 
                    changes.has_wiki || changes.has_downloads || changes.has_pages || 
                    changes.has_discussions || changes.allow_squash_merge || 
                    changes.allow_merge_commit || changes.allow_rebase_merge || 
                    changes.allow_auto_merge || changes.delete_branch_on_merge || 
                    changes.allow_update_branch || changes.use_squash_pr_title_as_default || 
                    changes.squash_merge_commit_message || changes.squash_merge_commit_title || 
                    changes.merge_commit_message || changes.merge_commit_title) {
                  
                  const message = {
                    blocks: [
                      {
                        type: "header",
                        text: {
                          type: "plain_text",
                          text: "🚨 Repository Settings Changed"
                        }
                      },
                      {
                        type: "section",
                        fields: [
                          {
                            type: "mrkdwn",
                            text: `*Repository:*\n${repository.full_name}`
                          },
                          {
                            type: "mrkdwn",
                            text: `*Changed by:*\n${sender.login}`
                          }
                        ]
                      }
                    ]
                  };

                  // Add changes section
                  const changesText = Object.entries(changes).map(([key, value]) => {
                    const fromValue = value.from !== undefined ? ` from ${JSON.stringify(value.from)}` : '';
                    const toValue = value.to !== undefined ? ` to ${JSON.stringify(value.to)}` : '';
                    return `• ${key} changed${fromValue}${toValue}`;
                  }).join('\n');
                  
                  message.blocks.push({
                    type: "section",
                    text: {
                      type: "mrkdwn",
                      text: `*Changes:*\n\`\`\`\n${changesText}\n\`\`\``
                    }
                  });

                  // Add timestamp
                  message.blocks.push({
                    type: "context",
                    elements: [
                      {
                        type: "mrkdwn",
                        text: `Time: ${new Date().toISOString()}`
                      }
                    ]
                  });

                  console.log('Sending repository settings change message to Slack:', JSON.stringify(message, null, 2));
                  await github.request({
                    method: 'POST',
                    url: process.env.SLACK_WEBHOOK_URL,
                    headers: {
                      'Content-Type': 'application/json',
                    },
                    data: message
                  });
                  console.log('Repository settings change notification sent successfully');
                  return;
                }
              }
              
              // Handle push events
              const repository = event.repository;
              const sender = event.sender;
              const ref = event.ref;
              const commits = event.commits;
              
              // Format the message for Slack
              const message = {
                blocks: [
                  {
                    type: "header",
                    text: {
                      type: "plain_text",
                      text: "🚨 Push to Protected Branch"
                    }
                  },
                  {
                    type: "section",
                    fields: [
                      {
                        type: "mrkdwn",
                        text: `*Repository:*\n${repository.full_name}`
                      },
                      {
                        type: "mrkdwn",
                        text: `*Branch:*\n${ref}`
                      }
                    ]
                  },
                  {
                    type: "section",
                    fields: [
                      {
                        type: "mrkdwn",
                        text: `*Pushed by:*\n${sender.login}`
                      },
                      {
                        type: "mrkdwn",
                        text: `*Commits:*\n${commits.length}`
                      }
                    ]
                  }
                ]
              };

              // Add timestamp
              message.blocks.push({
                type: "context",
                elements: [
                  {
                    type: "mrkdwn",
                    text: `Time: ${new Date().toISOString()}`
                  }
                ]
              });

              console.log('Sending push notification to Slack:', JSON.stringify(message, null, 2));
              
              // Send to Slack
              await github.request({
                method: 'POST',
                url: process.env.SLACK_WEBHOOK_URL,
                headers: {
                  'Content-Type': 'application/json',
                },
                data: message
              });
              
              console.log('Push notification sent successfully');
              
            } catch (error) {
              console.error('Error sending Slack notification:', error);
              console.error('Error details:', {
                status: error.status,
                message: error.message,
                documentation_url: error.documentation_url
              });
              throw error;
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }} 
